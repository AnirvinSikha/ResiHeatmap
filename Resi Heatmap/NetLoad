import PVWatts
import LoadProfile
import Parser
import csv
import Dispatch
import pandas as pd

LA = "USA_CA_Los.Angeles.Intl.AP.722950_TMY3_HIGH.csv"
ratesEWeek = "RateEweek.csv"

LosAngeles = Parser.fileParse(LA)
rates = Parser.fileParse(ratesEWeek)

output = LoadProfile.run(LosAngeles, rates)
dates = output[0]
consumption = output[1]
before_solar = output[2]
solar = PVWatts.run("90001")
net_load = []
for i in range(len(consumption)):
    net_load += [consumption[i] - solar[i]]

import_rates = output[3]
export_rates = []
for i in range(len(import_rates)):
    export_rates += [import_rates[i] - .03]

after_solar = []
for i in range(len(net_load)):
    if net_load[i] >= 0:
        after_solar += [net_load[i] * import_rates[i]]
    else:
        after_solar += [net_load[i] * export_rates[i]]

with open("table.csv", 'w') as output_file:
    headers = ["Date/Time", "Load", "Bill Before Solar", "Solar", "Net Load", "Bill Solar Only", "Import Rate", "Export Rate"]
    writer = csv.DictWriter(output_file, headers)

    writer.writeheader()
    for i in range(len(dates)):
        writer.writerow({"Date/Time": dates[i], "Load": consumption[i], "Bill Before Solar": before_solar[i],
                        "Solar": solar[i], "Net Load": net_load[i], "Bill Solar Only": after_solar[i],
                         "Import Rate": import_rates[i], "Export Rate": export_rates[i]})

print "I'm here!"
d = pd.read_csv("table.csv")
d = Dispatch.full_basic_dispatch(d, 1)
d.to_csv("table.csv")

